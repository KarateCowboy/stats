#!/usr/bin/env node
/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */

const Script = require('./script')
const _ = require('lodash')
const path = require('path')

class UpdateVersions extends Script {

  async run () {
    await this.setup('update-versions-from-crashes')
    const versions = (await db.Crash.query().distinct(knex.raw('contents->>\'_version\' as _version'))).map(c => c._version)
    await Promise.all(versions.map(async (version) => {
      const res = await db.Version.query().where('num', version)
      if (_.isEmpty(res)) {
        await db.Version.query().insert({num: version})
      }
    }))

    await this.shutdown()
  }
}

const update_versions = new UpdateVersions(path.basename(__filename))

update_versions.run()
