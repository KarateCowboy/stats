#!/usr/bin/env node

/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */

const mongoc = require('../src/mongoc')
const pgc = require('../src/pgc')
const reporter = require('../src/reporter')
const moment = require('moment')
const UpdateMonth = require('../src/services/update-postgres-month.service')
const Knex = require('knex')
const path = require('path')

const args = require('yargs')
  .default('collection', 'usage')
  .default('start', moment().startOf('month').subtract(1,'days').format('YYYY-MM-DD'))
  .default('end', moment().add(1,'days').format('YYYY-MM-DD'))
  .argv

const validCollections = ['usage', 'android_usage', 'ios_usage','brave_core_usage']
if (validCollections.indexOf(args.collection) === -1) {
  console.log('Invalid collection ' + args.collection)
  process.exit(1)
}

const jobName = path.basename(__filename)
const runInfo = reporter.startup(jobName)
const main = async () => {
  global.mongo_client = await mongoc.setupConnection()
  global.pg_client = await pgc.setupConnection()
  global.knex = await Knex({client: 'pg', connection: process.env.DATABASE_URL})
  const month_service = new UpdateMonth()
  await month_service.main(args.collection, args.start, args.end)

  await global.pg_client.end()
  await global.mongo_client.close()
  await global.knex.destroy()
}

main()
